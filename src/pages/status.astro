---
import Layout from '../layouts/Layout.astro';

const env = Astro.locals.runtime.env;

let discordStatus = 'Unknown';
let guilds = [];
let errorMsg = '';

try {
    const userResp = await fetch('https://discord.com/api/v10/users/@me', {
        headers: { Authorization: `Bot ${env.DISCORD_TOKEN}` }
    });
    if (userResp.ok) {
        discordStatus = 'Online';
        const guildsResp = await fetch('https://discord.com/api/v10/users/@me/guilds', {
            headers: { Authorization: `Bot ${env.DISCORD_TOKEN}` }
        });
        if (guildsResp.ok) {
            guilds = await guildsResp.json();
        }
    } else {
        discordStatus = 'Unreachable';
        errorMsg = `Discord API Error: ${userResp.status}`;
    }
} catch (e) {
    discordStatus = 'Error';
    errorMsg = e.message;
}

const functionalities = [
    { name: 'Slash Commands', status: 'Operational', icon: 'âš¡' },
    { name: 'Status Page', status: 'Operational', icon: 'ðŸ“Š' },
    { name: 'Discord Gateway', status: discordStatus === 'Online' ? 'Operational' : 'Outage', icon: 'ðŸ”Œ' }
];
---

<Layout title="DDT Bot Status">
	<main class="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-gray-900 to-gray-800">
		<div class="w-full max-w-3xl bg-gray-800/50 backdrop-blur-lg rounded-2xl shadow-2xl border border-gray-700 overflow-hidden">
            <!-- Header -->
            <div class="p-8 text-center border-b border-gray-700 bg-gray-800/80">
                <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">
                    Dumb Decision TTRPG Bot
                </h1>
                <p class="text-gray-400 text-lg">System Status Dashboard</p>
            </div>

            <div class="p-8 space-y-8">
                <!-- System Status -->
                <section>
                    <h2 class="text-xl font-semibold text-gray-300 mb-4 flex items-center gap-2">
                        <span class="w-2 h-6 bg-blue-500 rounded-full"></span>
                        System Status
                    </h2>
                    <div class="grid gap-4 md:grid-cols-2">
                        <div class="bg-gray-700/50 p-4 rounded-xl border border-gray-600 flex justify-between items-center">
                            <span class="text-gray-300">Worker Status</span>
                            <span class="flex items-center gap-2 text-green-400 font-bold bg-green-400/10 px-3 py-1 rounded-full text-sm">
                                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                                Online
                            </span>
                        </div>
                        <div class="bg-gray-700/50 p-4 rounded-xl border border-gray-600 flex justify-between items-center">
                            <span class="text-gray-300">Discord API</span>
                            <span class={`flex items-center gap-2 font-bold px-3 py-1 rounded-full text-sm ${discordStatus === 'Online' ? 'text-green-400 bg-green-400/10' : 'text-red-400 bg-red-400/10'}`}>
                                <span class={`w-2 h-2 rounded-full ${discordStatus === 'Online' ? 'bg-green-400 animate-pulse' : 'bg-red-400'}`}></span>
                                {discordStatus}
                            </span>
                        </div>
                    </div>
                    {errorMsg && <div class="mt-2 text-red-400 text-sm bg-red-400/10 p-2 rounded border border-red-400/20">{errorMsg}</div>}
                </section>

                <!-- Functionalities -->
                <section>
                    <h2 class="text-xl font-semibold text-gray-300 mb-4 flex items-center gap-2">
                        <span class="w-2 h-6 bg-purple-500 rounded-full"></span>
                        Services
                    </h2>
                    <div class="grid gap-3">
                        {functionalities.map(f => (
                            <div class="bg-gray-700/30 p-4 rounded-xl border border-gray-600/50 flex justify-between items-center hover:bg-gray-700/50 transition-colors">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">{f.icon}</span>
                                    <span class="text-gray-200 font-medium">{f.name}</span>
                                </div>
                                <span class={`font-bold px-3 py-1 rounded-full text-xs uppercase tracking-wider ${f.status === 'Operational' ? 'text-green-400 bg-green-400/10' : 'text-red-400 bg-red-400/10'}`}>
                                    {f.status}
                                </span>
                            </div>
                        ))}
                    </div>
                </section>

                <!-- Deployed Servers -->
                <section>
                    <h2 class="text-xl font-semibold text-gray-300 mb-4 flex items-center gap-2">
                        <span class="w-2 h-6 bg-pink-500 rounded-full"></span>
                        Deployed Servers <span class="text-gray-500 text-sm font-normal ml-2">({guilds.length})</span>
                    </h2>
                    <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                        {guilds.map((g: any) => (
                            <div class="bg-gray-700/30 p-3 rounded-xl border border-gray-600/50 flex items-center gap-3 hover:bg-gray-700/50 transition-all hover:scale-[1.02]">
                                {g.icon ? (
                                    <img src={`https://cdn.discordapp.com/icons/${g.id}/${g.icon}.png`} alt={g.name} class="w-10 h-10 rounded-full shadow-md" />
                                ) : (
                                    <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center text-sm font-bold shadow-md">
                                        {g.name.substring(0, 2)}
                                    </div>
                                )}
                                <span class="text-gray-200 font-medium truncate">{g.name}</span>
                            </div>
                        ))}
                        {guilds.length === 0 && (
                            <div class="col-span-full text-center py-8 text-gray-500 italic bg-gray-700/20 rounded-xl border border-gray-700 border-dashed">
                                No servers found or unable to fetch list.
                            </div>
                        )}
                    </div>
                </section>
            </div>
            
            <!-- Footer -->
            <div class="p-4 text-center text-gray-500 text-sm border-t border-gray-700 bg-gray-800/80">
                Powered by Cloudflare Workers & Astro
            </div>
		</div>
	</main>
</Layout>

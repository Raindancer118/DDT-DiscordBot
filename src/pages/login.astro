---
import Layout from "../layouts/Layout.astro";

// In a real implementation this would handle the OAuth callback code as well
// or redirect to a specific /api/auth/discord endpoint.
// For this MVP, we will simulate the "Sign in with Discord" button.

const runtimeEnv = Astro.locals.runtime?.env || {};
const runtimeEnv = Astro.locals.runtime?.env || {};

const DISCORD_CLIENT_ID = runtimeEnv.DISCORD_CLIENT_ID;
const REDIRECT_URI = runtimeEnv.DISCORD_REDIRECT_URI;

if (!DISCORD_CLIENT_ID || !REDIRECT_URI) {
    throw new Error("Missing DISCORD_CLIENT_ID or DISCORD_REDIRECT_URI in environment variables.");
}

const discordLoginUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=identify%20email`;
---

<Layout title="Login via DumbDecision">
    <main
        class="min-h-screen flex items-center justify-center bg-gray-900 text-white"
    >
        <div
            class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full border border-gray-700"
        >
            <h1 class="text-3xl font-bold mb-6 text-center text-purple-400">
                Login via DumbDecision
            </h1>

            <form
                id="login-form"
                class="space-y-4 mb-6"
                data-discord-url={discordLoginUrl}
            >
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1"
                        >Email</label
                    >
                    <input
                        name="email"
                        type="email"
                        required
                        class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white focus:outline-none focus:border-purple-500"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-1"
                        >Password</label
                    >
                    <input
                        name="password"
                        type="password"
                        required
                        class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white focus:outline-none focus:border-purple-500"
                    />
                </div>
                <div id="error-msg" class="text-red-500 text-sm hidden"></div>
                <button
                    type="submit"
                    class="w-full py-2 bg-purple-600 hover:bg-purple-500 rounded font-semibold transition-colors"
                >
                    Log In & Link Discord
                </button>
            </form>

            <div class="relative flex py-5 items-center">
                <div class="flex-grow border-t border-gray-700"></div>
                <span class="flex-shrink-0 mx-4 text-gray-500 text-sm"
                    >Or for Verification</span
                >
                <div class="flex-grow border-t border-gray-700"></div>
            </div>

            <div class="space-y-4">
                <a
                    href={discordLoginUrl}
                    class="block w-full py-3 px-4 bg-[#5865F2] hover:bg-[#4752C4] rounded text-center font-semibold transition-colors flex items-center justify-center gap-2"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="20"
                        height="20"
                        fill="currentColor"
                        viewBox="0 0 16 16"
                    >
                        <path
                            d="M13.545 2.907a13.227 13.227 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.19 12.19 0 0 0-3.658 0 8.258 8.258 0 0 0-.412-.833.051.051 0 0 0-.052-.025c-1.125.194-2.209.534-3.257 1.011a.041.041 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019c.308-.42.582-.863.818-1.329a.05.05 0 0 0-.01-.059.051.051 0 0 0-.018-.011 8.875 8.875 0 0 1-1.248-.595.05.05 0 0 1-.02-.066.051.051 0 0 1 .015-.019c.246.186.495.362.747.522a.051.051 0 0 0 .065-.005 12.747 12.747 0 0 0 8.58-3.078 12.122 12.122 0 0 0-2.355 2.502.05.05 0 0 0 .056.035 9.163 9.163 0 0 1 1.248.595.05.05 0 0 0 .038.125c.236-.466.51-.909.818-1.329a.05.05 0 0 0 .056.019 13.276 13.276 0 0 0 3.995-2.02.041.041 0 0 0 .021-.037c.304-3.078-.291-6.101-2.176-9.102a.042.042 0 0 0-.021-.018Z"
                        ></path>
                    </svg>
                    Link Discord Account
                </a>

                <div class="text-center text-sm text-gray-500">
                    Don't have a Dumb Decision account?
                    <a
                        href="https://dumbdecision.de/members"
                        class="text-purple-400 hover:text-purple-300"
                        target="_blank">Register here</a
                    >
                </div>
            </div>
        </div>
    </main>
</Layout>

<script>
    const form = document.getElementById("login-form") as HTMLFormElement;
    const errorMsg = document.getElementById("error-msg");

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        errorMsg!.classList.add("hidden");

        const formData = new FormData(form);

        try {
            const res = await fetch("/api/auth/login", {
                method: "POST",
                body: formData,
            });

            const data = await res.json();

            if (res.ok) {
                const discordUrl = form.dataset.discordUrl;
                if (discordUrl) {
                    window.location.href = discordUrl;
                } else {
                    window.location.href = "/dashboard";
                }
            } else {
                errorMsg!.textContent = data.error || "Login failed";
                errorMsg!.classList.remove("hidden");
            }
        } catch (err) {
            errorMsg!.textContent = "An error occurred";
            errorMsg!.classList.remove("hidden");
        }
    });
</script>
